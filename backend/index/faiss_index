import json
import faiss
import numpy as np
from sentence_transformers import SentenceTransformer

DATA_FILE = "backend/data/news.jsonl"

class FaissIndex:
    def __init__(self):
        self.model = SentenceTransformer("all-MiniLM-L6-v2")
        self.index = None
        self.texts = []

    def build(self):
        embeddings = []

        with open(DATA_FILE, "r") as f:
            for line in f:
                obj = json.loads(line)
                text = obj["text"]
                emb = self.model.encode(text)
                embeddings.append(emb)
                self.texts.append(obj)

        vectors = np.array(embeddings).astype("float32")
        dim = vectors.shape[1]

        self.index = faiss.IndexFlatL2(dim)
        self.index.add(vectors)

        print(f"[FAISS] Indexed {len(vectors)} documents")

    def query(self, q, k=3):
        q_emb = self.model.encode(q).astype("float32").reshape(1, -1)
        D, I = self.index.search(q_emb, k)
        return [self.texts[i] for i in I[0]]
